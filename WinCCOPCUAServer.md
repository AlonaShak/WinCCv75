# Принцип роботи сервера WinCC OPC UA

## Як це працює

Сервер WinCC OPC UA надає такі значення:

- Значення тегів процесу

- Значення архівних тегів

- Повідомлення WinCC (messeges) підсистеми алармів


Сервер WinCC OPC UA встановлюється як служба Windows і запускається автоматично. Сервер WinCC OPC UA підтримує лише профіль зв’язку «UA-TCP UA-SC UA Binary». Використовуваний номер порту регулюється.

## Підтримувані специфікації

Unified architechture OPC — це специфікація для передачі значень процесу, архівних даних і повідомлень. Сервер WinCC OPC UA підтримує специфікацію OPC UA 1.03. Додаткову інформацію про підтримувані функції UA див. у розділі «Підтримувані служби та профілі OPC UA».

## Інсталяція

Після встановлення WinCC сервер WinCC OPC UA можна використовувати одразу без необхідності будь-якої подальшої конфігурації.
Сервер WinCC OPC UA можна використовувати на сервері WinCC або клієнті WinCC.

## URL-адреса сервера WinCC OPC UA

Доступ до сервера WinCC OPC UA здійснюється за такою URL-адресою:

"**opc.tcp://[Host]:[Port]**"

| Параметр | Опис                                                         |
| -------- | ------------------------------------------------------------ |
| HostName | Заповнювач для імені комп’ютера. Використовується автоматично |
| Port     | Номер порту. Значення за замовчуванням — «**4862**».         |

## Discovery Server 

«Discovery Server» доступний від OPC foundation. «Discovery Server» за замовчуванням інстальовано на пристрої HMI як служба Windows.

На «Discovery Server» через сервер OPC UA доступна інформація клієнтів UA, яка зареєстрована на «Discovery Server».

Залежно від конфігурації сервер WinCC OPC UA реєструється на ні, на одному або на кількох налаштованих і доступних «Discovery Server» під час запуску. Потім реєстрація повторюється циклічно. Якщо ви завершуєте Runtime, сервер WinCC OPC UA автоматично виходить із «Discovery Server».

## Підтримувані мови в адресній області WinCC

WinCC OPC A&E Server підтримує адресну область WinCC такими мовами:

- Німецька

- Англійська

- Французька

- Італійська

- Іспанська


# Концепція безпеки OPC UA

### Вступ

Концепція безпеки OPC UA в основному базується на:

- Автентифікація та авторизація залучених програм і користувачів

- Забезпечення цілісності та конфіденційності повідомлень, якими обмінюються програми


Сертифікати є методом автентифікації програм OPC UA.

Кожна програма має власний сертифікат примірника, за допомогою якого вона ідентифікує себе в інфраструктурі відкритих ключів. Сертифікат примірника також називають «сертифікатом програми».

### Сертифікат сервера WinCC OPC UA

Для безпечної роботи кожному серверу WinCC OPC UA потрібен власний сертифікат із приватним ключем (private key), сертифікат сервера.

Сертифікат дійсний лише на **відповідному комп’ютері** та може використовуватися лише сервером WINCC OPC UA, встановленим на цьому комп’ютері.

Самопідписаний сертифікат сервера створюється та зберігається в папці сертифіката сервера.

Приватний ключ для цього сертифіката сервера також зберігається в папці сертифіката. Ви повинні обмежити доступ до папки з приватним ключем для:

- самого сервера

- системний адміністратор

```
Доступ до папки із приватим ключем

З міркувань безпеки жодні інші користувачі або програми, окрім сервера та системного адміністратора, не можуть мати доступ до закритого ключа сервера WINCC OPC UA.
```

Адміністратор заводу може замінити сертифікат сервера та відповідний приватний ключ, згенерований під час встановлення.

Відповідно до застосовної концепції безпеки для системи новий сертифікат сервера може бути самопідписаним або виданим центром сертифікації.

Сертифікати, які використовує сервер WINCC OPC UA, визначаються налаштуваннями у файлі конфігурації "OpcUaServerWinCC.xml": Ви можете знайти додаткову інформацію у розділі "Файл конфігурації сервера WinCC OPC UA".

### Зберігання сертифікатів сервера

Програма «WinCC OPC UA server» зберігається за таким шляхом:

| Storage path                                | Application          | Configuration file   |
| ------------------------------------------- | -------------------- | -------------------- |
| <Installation directory>WinCC\opc\UAServer\ | OpcUaServerWinCC.exe | OpcUaServerWinCC.xml |


Сертифікати WinCC OPC UA зберігаються в таких папках шляху встановлення WinCC:

| WinCC OPC UA server | Certificates | opc\UAServer\PKI\CA\certs   |
| :------------------ | ------------ | --------------------------- |
|                     | Private key  | opc\UAServer\PKI\CA\private |

Ви можете змінити місце зберігання у файлі конфігурації.

### Сертифікати довірених клієнтів

Сервер WinCC OPC UA підтримує безпечний зв’язок лише з надійними клієнтами. Клієнту довіряють:

- Якщо клієнт має дійсний самопідписаний сертифікат, який зберігається в пам’яті сертифікатів довірених сертифікатів сервера WinCC OPC UA

- або якщо дійсний сертифікат клієнта був виданий центром сертифікації.


Дійсний сертифікат від центру сертифікації повинен знаходитися в пам’яті сертифікатів довірених сертифікатів сервера WinCC OPC UA. У цьому випадку потрібен лише сертифікат від центру сертифікації. Сертифікат клієнта не обов’язково повинен знаходитися в сховищі сертифікатів для довірених сертифікатів.

### Зберігання клієнтських сертифікатів

Ви вказуєте параметри зберігання для довірених сертифікатів за допомогою файлу конфігурації сервера WINCC OPC UA:

| Параметр  | Значення                                                     |
| --------- | ------------------------------------------------------------ |
| StoreType | Тип зберігання сертифіката. Місцем зберігання може бути «Directory» або «Windows». |
| StorePath | У цій папці зберігаються сертифікати довірених клієнтів.     |

#### Приклад конфігурації зі сховищем «Directory»

```xml
<TrustedCertificateStore>
      <StoreType>Directory</StoreType>
      <StorePath>[ApplicationPath]\PKI\Trusted</StorePath>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
</TrustedCertificateStore>
```

У цьому випадку сервер WINCC OPC UA довіряє всім клієнтам, чиї сертифікати сервера знаходяться в папці «…PKI\TrustList\Certs».



#### Приклад конфігурації зі сховищем «Windows»

```xml
<TrustedCertificateStore>
      <StoreType>Windows</StoreType>
      <StorePath>UA Aplications</StorePath>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
</TrustedCertificateStore>
```

Для цього варіанта зберігання сертифікати клієнтів мають бути розташовані в сховищі сертифікатів операційної системи в розділі «<Локальний комп’ютер>\UA Applications».

Сертифікати центрів сертифікації, необхідні для перевірки ланцюжка сертифікатів клієнта, зберігаються в сховищі сертифікатів центрів сертифікації. Тут також ви вказуєте параметри зберігання за допомогою файлу конфігурації сервера WINCC OPC UA:

| Параметр  | Значення                                                     |
| --------- | ------------------------------------------------------------ |
| StoreType | Тип зберігання сертифіката. Місцем зберігання може бути «Directory» або «Windows». |
| StorePath | У цій папці зберігаються сертифікати довірених центрів сертифікації. |

```
Сертифікати з пам’яті центрів сертифікації не є автоматично довіреними.

Щоб центр сертифікації був надійним, його сертифікат повинен знаходитися в пам’яті для довірених сертифікатів.
```

#### Приклад конфігурації зі сховищем «Directory»

```xml
    <IssuerCertificateStore>
     <StoreType>Directory<StoreType />
      <StorePath>[ApplicationPath]\PKI\CA<StorePath/>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
    </IssuerCertificateStore>
```

У цьому випадку сертифікати довірених центрів сертифікації знаходяться в папці «…\PKI\CA\Certs».

#### Приклад конфігурації зі сховищем «Windows»

```xml
    <IssuerCertificateStore>
     <StoreType>Windows<StoreType />
     <ValidationOptions>UseDefaultOptions</ValidationOptions>
    </IssuerCertificateStore>
```

Параметр "StorePath" не має значення. Сертифікати центрів сертифікації повинні зберігатися в пам’яті сертифікатів Windows відповідно до вимог операційної системи.

Сертифікати вважаються надійними, якщо вони знаходяться в одному з цих двох місць:

- <Local computer>\Trusted root certification authorities
- <Local computer>\Third-party root certification authorities

```
Важливо для зберігання

Місце зберігання для сертифіката сервера має бути «Directory».

Два місця зберігання для сертифікатів довірених клієнтів і для сертифікатів від центрів сертифікації повинні мати однаковий StoreType, тобто обидва мають бути або «Directory», або «Windows».
```

#### Клієнтські сертифікати не приймаються

Якщо клієнт UA отримує доступ до сервера WINCC OPC UA, не маючи довіреного сертифіката, сервер WINCC OPC UA не дозволяє безпечний зв’язок і копіює сертифікат клієнта в папку для відхилених сертифікатів.

Ви вказуєте параметри зберігання для відхилених сертифікатів, наприклад, за допомогою файлу конфігурації сервера WINCC OPC UA

```xml
<RejectedCertificatesStore>
      <StoreType>Directory</StoreType>
      <StorePath>[ApplicationPath]\PKI\CA\rejected</StorePath>
    </RejectedCertificatesStore>
```

```
Тут також підтримується лише StoreType "Directory".
```

Щоб увімкнути захищений зв’язок із цим клієнтом, вам доведеться перемістити відхилений сертифікат до сховища сертифікатів для lдовірених сертифікатів.

# Налаштування механізмів безпеки

## Вступ

На комунікаційному рівні забезпечується:

- Автентичність програми UA

- Конфіденційність повідомлень, якими обмінюються

- Цілісність повідомлень, якими обмінюються


Використовувані механізми безпеки, наприклад алгоритми шифрування та підпису, визначаються стандартизованими політиками безпеки.

Політики безпеки, які підтримуються сервером WinCC OPC UA, налаштовуються за допомогою файлу конфігурації сервера в «ServerConfiguration» і «SecuredApplication».

## Конфігурація сервера

Елемент XML «SecurityPolicies» у розділі «ServerConfiguration» містить список усіх доступних комбінацій «Security Profile» і «Message Security Mode» для сервера.

| Security Profile                                             | Message Security Mode  | Description                                                  |
| ------------------------------------------------------------ | ---------------------- | ------------------------------------------------------------ |
| http://opcfoundation.org/UA/SecurityPolicy#None              | None                   | Незахищений зв'язок                                          |
| http://opcfoundation.org/UA/SecurityPolicy#Basic128Rsa15     | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |
| http://opcfoundation.org/UA/SecurityPolicy#Basic256          | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |
| http://opcfoundation.org/UA/SecurityPolicy#Basic256Sha256  (Вимоги до використання політики безпеки «Basic256Sha256»: сертифікат примірника з алгоритмом підпису «Sha256» і мінімальною довжиною ключа = 2048.) | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |

```
Забезпечення безпечного зв'язку

Для безпечного зв’язку потрібні сертифікати сервера для сервера та клієнта та правильно налаштоване сховище сертифікатів.
```

## Приклад конфігураційного файлу з максимальною функціональністю

![](media\1.png)

## SecuredApplication

Відповідно до специфікації OPC UA, механізми безпеки явно вмикаються та вимикаються за допомогою елемента «SecurityProfileUris» у розділі «SecuredApplication».

На діаграмі нижче показано SecuredApplication, у якому незахищений зв’язок вимкнено:

![](media\2.png)

Тому сервер WinCC OPC UA підтримує дві стратегії безпеки «Basic128Rsa15» і «Basic256» під час виконання. З «Message Security Modes Sign» і «SignAndEncrypt», але без незахищеного зв’язку.

Після встановлення зв’язку клієнти UA вибирають із цього списку необхідну Політику.

## Ідентичність користувача

На додаток до механізмів безпеки на рівні зв’язку, сервер WinCC OPC UA також підтримує автентифікацію користувачів для клієнтських програм за допомогою UserTokenPolicy «UserName».

Клієнтська програма повинна надавати дійсну комбінацію імені користувача та пароля під час встановлення зв’язку. Сервер WinCC OPC UA перевіряє комбінацію в управлінні користувачами операційної системи.

UserTokenPolicy встановлюється у файлі конфігурації сервера WINCC OPC UA.

![](media\3.png)

З цією конфігурацією сервер WINCC OPC UA підтримує як анонімних користувачів, так і політику «UserName».

# Підтримувані сервіси та профілі OPC UA

## OPC UA services 

WinCC OPC A&E Server підтримує наступні описані функції.

У наведеній нижче таблиці підсумовано функціональність, яку підтримує сервер OPC UA 1.0.9:

| OPC UA Service Sets                         | Services                                                     | Comment                                                      |
| ------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Discovery Service Set                       | FindServers, GetEndpoints                                    |                                                              |
| Secure Channel Service, Session Service Set | Всі                                                          |                                                              |
| View Service Set                            | Browse, BrowseNext, RegisterNodes, UnregisterNodes           | Визначення відображених даних WinCC: значення процесу та архівні дані |
| Attribute Service Set                       | Read, Write, HistoryRead, HistoryUpdate                      | only WinCC tags, only WinCC tags, Only archived tags, Only archived tags |
| Subscription Service Set                    | CreateSubscription, SetPublishingMode, Publish, RePublish, DeleteSubscription |                                                              |
| MonitoredItem Service Set                   | CreateMonitoredItems, SetMonitoringMode, DeleteMonitoredItems | Only "Value" attribute of WinCC tags, Event Notifier during access to WinCC messages |
| Method Service Set                          | Call                                                         | Acknowledge, ConditionRefresh                                |

## Профіль OPC UA та одиниці відповідності

Сервер WinCC OPC UA підтримує такі профілі OPC UA 1.03 без обмежень:

- 6.5.5 Base Server Behaviour Facet 
- 6.5.16 Standard Event Subscription Server Facet

- 6.5.18 A & C Base Condition Server Facet

- 6.5.30 Method Server Facet

- 6.5.36 Historical Raw Data Server Facet

- 6.5.42 Historical Data Update Server Facet 

- 6.5.44 Historical Data Insert Server Facet 

- 6.5.45 Historical Data Delete Server Facet

- 6.5.131 UA-TCP UA-SC UA Binary 

- 6.5.149 SecurityPolicy - Basic256 
- 6.5.148 SecurityPolicy - Basic128Rsa15

- 6.5.147 SecurityPolicy - None

- 6.5.150 SecurityPolicy - Basic256Sha256

Сервер WinCC OPC A&E підтримує наступні профілі OPC UA, показані в наступній таблиці, але з обмеженнями:

| Profile                                               | "Group"                 | Not supported "Conformance Unit"                             |
| ----------------------------------------------------- | ----------------------- | ------------------------------------------------------------ |
| 6.5.2 Core Server Facet                               | Attribute Services      | Attribute Write Index                                        |
| 6.5.11 Standard DataChange, Subscription Server Facet | Monitored Item Services | DeadBand Filter                                              |
| 6.5.12 Enhanced DataChange Subscription Server Facet  | Monitored Item Services |                                                              |
| 6.5.14 Data Access Server Facet                       | Data Access             | Data Access Analog, Data Access Multistate, Data Access PercentDeadBand, Data Access Semantic Changes, Data Access Two State |
| 6.5.55 Standard UA Server Profile                     | Attribute Services      | Attribute Write StatusCode & Timestamp                       |

# Область імен сервера WinCC OPC UA

## Вступ

Сервер WinCC OPC UA надає клієнтам OPC UA ієрархічну область імен і доступ до таких даних виконання:

- Значення процесу (теги WinCC і групи тегів WinCC)

- Журнал даних, включаючи теги реєстрації

- Повідомлення WinCC


Область імен сервера WinCC OPC UA приєднана до стандартної папки «Objects».

На наступному екрані показано область імен сервера WinCC OPC UA активного проекту WinCC на локальному ПК («@LOCALMACHINE::»):

![](media\4.png)

1 – Початковий вузол спеціальної області імен WinCC.

2 – Відображення тегів WinCC; структура відповідає структурі тегів у WinCC.

3 – Відображення журналу даних.

## Відображення тегів WinCC

Групи тегів, комунікаційні драйвери та з'єднання відображаються об'єктами OPC UA типу "FolderType". Кожна з цих папок має посилання типу «Організує» на підлеглі об’єкти та теги.

Внутрішні та зовнішні теги WinCC відображаються тегами OPC UA типу "DataItemType". Якщо тег WinCC додатково реєструється, відображений тег OPC UA додатково містить посилання типу "HasHistoricalConfiguration" для конфігурації журналу. Атрибути «Historizing» і «AccessLevel» встановлюються відповідно.

У наступній таблиці показано найважливіші атрибути тегів OPC UA, які представляють тег WinCC. Ви можете знайти повний перелік атрибутів у документі «OPC UA Частина 3 – Специфікація моделі адресного простору 1.03» у розділі «§5.6»:

| Attribute   | Description                                                  | Comment                                        |
| ----------- | ------------------------------------------------------------ | ---------------------------------------------- |
| NodeId      | Unique designation of the WinCC tag                          |                                                |
| BrowseName  | WinCC tag name                                               |                                                |
| DisplayName | WinCC tag name                                               |                                                |
| Value       | Tag value and status                                         |                                                |
| DataType    | OPC UA data type that corresponds to the WinCC tag type, for example: Int32; signed 32 bit value; UInt32; unsigned 32 bit value |                                                |
| AccessLevel | "CurrentRead" / "CurrentWrite"; "HistoryRead" / "HistoryWrite" | correspondingly to the WinCC tag configuration |
| ValueRank   | Always "Scalar"                                              |                                                |

## Захист від запису та від читання

Ви можете захистити серверні теги WinCC OPC UA від доступу клієнтів.

У Керуванні тегами проекту WinCC ви активуєте наступний параметр в області властивостей тегів у групі «Параметри»:

| Property             | Behavior in Runtime                               |
| -------------------- | ------------------------------------------------- |
| OPC write protection | Clients only have read access to the tag value.   |
| OPC read protection  | Clients can neither read nor write the tag value. |



## Немає зіставлення типів структур WinCC

Структури WinCC не можуть бути зіставлені як типи на сервері OPC UA.

Типи OPC UA можна пов’язувати лише з тегами структури WinCC.

## Відображення архівних тегів

Значення процесів і стиснуті журнали відображаються об'єктами OPC UA типу "FolderType". Кожна з цих папок містить посилання типу "Організує" на відповідні теги журналювання.

Теги реєстрації зі значення процесу або стиснені журнали відображаються тегами OPC UA типу "BaseDateVariableType". Тег журналювання завжди має посилання типу "HasHistoricalConfiguration" для конфігурації журналу.

У наступній таблиці показано найважливіші атрибути тегів OPC UA, які представляють тег журналювання WinCC. Ви можете знайти повний перелік атрибутів у документі «OPC UA Частина 3 – Специфікація моделі адресного простору 1.03» у розділі «§5.6»:

| Attribute   | Description                                                  | Comment                                                      |
| ----------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| NodeId      | Unique designation of a logging tag                          |                                                              |
| BrowseName  | Name of the archive tag                                      |                                                              |
| DisplayName | Name of the archive tag                                      |                                                              |
| Description | Node description                                             |                                                              |
| Value       | Not available                                                | For a logging tag, this attribute cannot be read nor changed. |
| DataType    | OPC UA data type that corresponds to the WinCC tag type, for example: Double; 64-bit floating-point number; UInt32; unsigned 32 bit value |                                                              |
| AccessLevel | "HistoryRead" / "HistoryWrite"                               |                                                              |
| ValueRank   | Always "Scalar"                                              |                                                              |

## Доступ до повідомлень WinCC

Початковий вузол простору імен WinCC — це сповіщувач подій, за допомогою якого клієнти OPC UA можуть отримувати зміни статусу повідомлень WinCC у середовищі виконання через підписки.

# OPC UA Data Access

Внутрішні та зовнішні теги WinCC відображаються тегами OPC UA типу "DataItemType". Інші типи тегів DataAccess, наприклад "AnalogItem" або "DiscreteType", не підтримуються.

WinCC OPC A&E Server підтримує доступ для читання атрибутів тегів OPC UA як "DataType" або "AccessLevel". Доступ для запису та підписки підтримуються лише для атрибута "Значення".



# OPC UA Historical Access

## Вступ

«OPC Historical Access» забезпечує доступ до архівів і включає сервіси «Історичні дані» та «Історичні події». Сервер WinCC OPC UA підтримує тільки службу «Історичні дані».

Сервер WinCC OPC UA пропонує клієнтам OPC доступ до необроблених даних архівів тегів через «Сервіси».

- HistoryRead (READRAW)

- Оновлення історії (INSERTDATA, REPLACEDATA, UPDATEDATA, DELETE_RAW)


Ви можете читати та обмежено записувати за допомогою клієнта OPC UA значення архівних тегів в архівах тегів. Залежно від конфігурації архіву тегів, тег архіву може містити необроблені дані або вже оброблені значення процесу.

## Характеристика архівних тегів

Тег процесу в WinCC може міститися в кількох архівах тегів. У цьому випадку тег процесу пов’язується з одним із відповідних тегів архіву.

## Властивості / Властивості конфігурацій архіву

У наступній таблиці показано властивості конфігурації тегу OPC UA типу "HistoricalConfigurationType": у властивості "Description" відображається коментар тегу архіву, налаштований у WinCC. Ви можете знайти повний перелік властивостей у документі «OPC UA, частина 11 – Специфікація історичного доступу 1.03» у розділі «§5.2.2»:

| Property   | Description / Value    | Comment                     |
| ---------- | ---------------------- | --------------------------- |
| Definition | WinCC process tag name | For a process value archive |
| Stepped    | True                   |                             |

Наступні додаткові властивості не підтримуються:

- MaxTimeInterval

- MinTimeInterval

- ExceptionDeviation

- ExceptionDeviationFormat


## Обмеження для служби "HistoryUpdate"

Сервіс «HistoryUpdate» можна використовувати тільки для архівів значень процесу.

У наступній таблиці перераховані функції, які підтримуються сервером WinCC OPC UA: Які функції підтримуються, залежить від конфігурації сервера WinCC OPC UA, а також конфігурації архіву значень процесу. Ви знайдете додаткову інформацію в документі «OPC UA, частина 11 – Специфікація історичного доступу 1.03» у розділі «§5.5»:

| Service       | Function    | Description                      |
| ------------- | ----------- | -------------------------------- |
| HistoryUpdate | INSERTDATA  | Insert new archive values        |
|               | REPLACEDATA | Replace existing archive values  |
|               | UPDATEDATA  | Replace of insert archive values |
|               | DELETE_RAW  | Delete archive values            |

# OPC UA Alarm & Conditions

## Вступ

Починаючи з WinCC 7.3, сервер OPC UA надає доступ до повідомлень системи повідомлень WinCC.

Сервер OPC UA пересилає зміни статусу повідомлень WinCC клієнтам OPC UA за допомогою WinCC-Event-Notifications через підписки та контрольовані події, але не підтримує екземпляр Condition у своєму просторі імен.

Вузол сповіщення про події, який буде використано, є початковим вузлом області імен WinCC.

Клієнт UA може фільтрувати повідомлення та визначати список повернутих атрибутів повідомлень.

Сервер OPC UA підтримує специфікацію "OPC UA Alarms & Conditions 1.03".

У наступному розділі описано відображення системи повідомлень WinCC на OPC UA. Ви можете знайти додаткову інформацію в специфікації в «Частині 9: Сигнали тривоги та умови 1.03 Специфікація».

## Відображення системи повідомлень WinCC на типи подій OPC UA

### BaseEventType

«BaseEventType» — це базовий тип, з якого походять типи подій OPC UA «WinCCEventType» і «WinCCAlarmConditionType».

```
Фільтр показує всі повідомлення WinCC

Коли ви фільтруєте "BaseEventType", ви отримуєте всі повідомлення WinCC.
```

Повідомлення WinCC зіставляються з такими типами подій OPC UA:

### WinCCEventType

Цей тип базується на "BaseEventType" і відображає "прості" повідомлення WinCC з такою теорією підтвердження:

- Активовано "Message without status went out"

- "Acknowledgment came in" не активовано


Прикладами такого типу повідомлення є запуск і зупинка двигунів.

### WinCCAlarmConditionType

Цей тип базується на "AlarmConditionType" і відображає всі повідомлення, які не можуть бути зіставлені в "WinCCEventType", наприклад, повідомлення з підтвердженням і повідомлення зі статусом "прийшло" та "вийшло".

У повідомленні типу "WinCCAlarmConditionType" подія пов'язана з умовою. Наприклад, WinCC генерує повідомлення, щойно буде порушено ліміт тегів. Це повідомлення в OPC UA еквівалентно умові тривоги.

### Атрибути повідомлень WinCC

Два типи подій додають специфічні для WinCC атрибути повідомлень до базового типу. Атрибути зіставляються 1:1 як властивості події UA і більш детально описані в розділі «Атрибути системи повідомлень WinCC».

## Клас і тип повідомлення

Система повідомлень WinCC інформує користувача про збої та умови роботи в процесі. Повідомлення WinCC завжди належить до певного класу та типу повідомлення, які вказані в атрибутах «CLASSID», «TYPEID», «CLASSNAME» та «TYPENAME» відповідних подій UA.

## Пріоритет

Під час налаштування повідомлень у системі повідомлень WinCC ви можете налаштувати пріоритет між «0» і «16». Специфікація OPC UA визначає діапазон значень від «1» до «1000» для рівня серйозності. «1» означає найнижчу, а «1000» — найвищу серйозність.

Таким чином, значення пріоритету повинні бути відповідним чином зіставлені зі ступенем серйозності OPC. У стандартному відображенні пріоритет «0» призначається OPC-Severity «1», а пріоритет «16» — OPC-Severity «1000». Усі інші значення інтерполюються лінійно між «0» і «1000».

## Правила відображення OPC UA

Під час налаштування системи повідомлень WinCC встановлюються налаштування, щоб визначити, які події процесу генерують повідомлення. Це повідомлення зазвичай відображається як подія в OPC UA.

У наступній таблиці показано найважливіші властивості подій і те, як система повідомлень WinCC надає інформацію.









# Файл конфігурації сервера WinCC OPC UA

## Вступ

Сервер WinCC OPC UA налаштовується за допомогою конфігураційного файлу "OPCUAServerWinCC.xml".

Файл конфігурації розбитий на кілька розділів. У цьому розділі описано макет файлу конфігурації.

У розділі «[Як налаштувати сервер OPC UA]()» описано, як налаштувати сервер WinCC OPC UA.

## Шлях файлу конфігурації

Для сервера WinCC OPC UA існує два файли конфігурації "OPCUAServerWinCC.xml":

| Configuration file                  | Storage path                            |
| ----------------------------------- | --------------------------------------- |
| Server-specific configuration file  | <WinCC installation path>\opc\UAServer\ |
| Project-specific configuration file | <WinCC project folder>\OPC\UAServer     |

## Редагування конфігураційного файлу

Для внесення змін у файли конфігурації вам потрібні наступні авторизації:

Server-specific configuration file -> Windows Administrator rights

Project-specific configuration file -> The user must be a member of the "SIMATIC HMI" user group

```
Ті самі параметри: Пріоритет файлів
Деякі параметри містяться в обох конфігураційних файлах.
Якщо параметри не збігаються, параметри файлу конфігурації конкретного проекту мають вищий пріоритет.
```

## Structure: Section <SecuredApplication>

У цьому розділі безпека програми OPC UA налаштована відповідно до Специфікації OPC UA / Частина 6 / § «Керування налаштуваннями безпеки».

Ви можете знайти додаткову інформацію за URL у розділі «Концепція безпеки OPC UA».

| <SecuredApplication>                                         |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <BaseAddresses> <...></...> </BaseAddresses>                 | Конфігурація URL-адреси сервера WinCC OPC UA.                |
| <SecurityProfileUris>   <SecurityProfile>     <...></...>   </SecurityProfile> ...</SecurityProfileUris> | Конфігурація підтримуваних політик безпеки. Використовуйте параметр «None» лише для тестування та діагностики |
| <ApplicationCertificate> <TrustedCertificateStore> <TrustedCertificates> <...> | Перегляд конфігурації сертифіката за замовчуванням відповідно до Специфікації OPC UA / Частина 6. (необов'язково). Ці параметри містяться лише у файлі конфігурації сервера. |
| </SecuredApplication>                                        |                                                              |

### Приклад: безпека програми OPC UA

![](media\5.png)

## Structure: Section <ServerConfiguration>

У цьому розділі встановлюються специфічні для сервера параметри.

Для отримання додаткової інформації про режими безпеки повідомлень зверніться до «Концепції безпеки OPC UA».

| <ServerConfiguration>                                        |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <SecurityPolicies>   <SecurityPolicy>   <...></...>   </SecurityPolicy>   ... </SecurityPolicies> | Конфігурація режимів безпеки повідомлень. Використовуйте параметр «None» лише для тестування та діагностики |
| <UserTokenPolicies>   <UserTokenPolicy>   <...></...>   </UserTokenPolicy>   ... </UserTokenPolicies> | Налаштування ідентифікації користувача. Використовуйте параметр «Anonymous» лише для тестування та діагностики |
| <FastInsert>  <Users>     <...></...>   </Users>   <Clients>     <...></...>   <Clients> </FastInsert> | Конфігурація оптимізованого доступу до архіву WinCC для запису |
| </ServerConfiguration>                                       |                                                              |

## Structure: Section <CertificateDescriptor>

Ви вказуєте параметри сертифіката для сервера WinCC OPC UA під заголовком <CertificateDescriptor> у розділі <ServerConfiguration>.

Ці параметри містяться лише у файлі конфігурації сервера.

Ви можете знайти додаткову інформацію про екземпляри сертифікатів у розділі «Концепція безпеки OPC UA».

| <ServerConfiguration>   <CertificateDescriptor>              |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <OrganizationUnit>...</...>   <Organization>...</...>   <Country>...</...> | Елементи опису. Параметри можна змінювати, але вони не впливають на роботу програм. |
| <KeyLength>...</...>                                         | Довжина приватного ключа, за допомогою якого створюється сертифікат. Довжина залежить від алгоритму підпису. 1024: мінімальна довжина для безпечного зв’язку через OPC UA; 2048: мінімальна довжина, коли використовується Sha256 (*****) |
| <SignatureAlgorithm>...</...>                                | Алгоритм підпису, який використовується для підписання сертифіката. Можливі значення: Sha1, Sha224, Sha256, Sha384, Sha512; Звичайні значення: Sha1, Sha256; Значення за замовчуванням: Sha256 із довжиною ключа 2048 |
| <LifetimeInMonths>...</...>                                  | Термін дії сертифіката в місяцях. Після закінчення зазначеного часу сервер більше не зможе працювати з цим сертифікатом. Значення за замовчуванням: 60 |
| </CertificateDescriptor> </ServerConfiguration>              |                                                              |

(*****) Для встановлення безпечного з’єднання з політикою безпеки «Basic256Sha256» серверу, а також клієнту OPC UA потрібен сертифікат із такими значеннями:

- KeyLength: принаймні 2048

- Алгоритм підпису: Sha256



### Приклад: Параметри для контролю сертифіката

![](media\6.png)

## Зміна шляху зберігання сертифіката сервера

При необхідності місце зберігання сертифіката сервера WinCC OPC UA може бути адаптоване адміністрацією підприємства.

Ви можете змінити ці параметри лише у файлі конфігурації сервера.

| Parameter | Value                                     | Meaning                                                      |
| --------- | ----------------------------------------- | ------------------------------------------------------------ |
| StoreType | Directory                                 | Type of certificate storage. The storage location must be "Directory". |
| StorePath | [ApplicationPath]\PKI\WINCC-OPC-UA-Server | The certificate and the private key are stored under this folder. |

### Приклад: шлях зберігання сертифіката сервера

![](media\7.png)

## Створення нових сертифікатів сервера

Для створення нових сертифікатів на сервері OPC UA потрібні права адміністратора.

1. Створіть резервну копію.

2. Видаліть наявні сертифікати та пов’язані з ними приватні ключі у відповідних папках.

3. У файлі конфігурації оновіть параметри сертифіката та збережіть файл XML.

4. Відкрийте вікно DOS "cmd.exe" в Windows з правами адміністратора.

5. Щоб створити сертифікати, перейдіть до шляху інсталяції програми OPC UA.

6. Введіть такий виклик:


​		OpcUaServerWinCC.exe /CreateCertificate

Нові сертифікати та приватні ключі створюються в шляхах зберігання.

# Як налаштувати сервер OPC UA

## Вимога

Створено проект WinCC.

## Відкриття конфігураційного файлу

Відкрийте Windows Explorer.·Перейдіть до каталогу «<папка проекту WinCC>OPC\UAServer».

Відкрийте файл конфігурації "OPCUAServerWinCC.xml". Для отримання додаткової інформації зверніться до «Файлу конфігурації сервера WinCC OPC UA»

## Зміна номера порту сервера WinCC OPC UA

За потреби змініть номер порту 4862 у розділі <BaseAddresses>.

Не використовуйте номер порту, який уже призначено іншій програмі.

Параметр [HostName] є заповнювачем для імені комп’ютера та визначається під час виконання.

Приклад:

```XML
<BaseAdresses>
<ua:String>opc.tcp://[HostName]:5210</ua:String>
<BaseAdresses>
```

## Вказівка параметрів безпеки

1. Укажіть параметри безпеки для зв’язку. Додаткову інформацію див. у розділі «Концепція безпеки OPC UA».

2. У <SecurityProfileUris> ви налаштовуєте підтримувані «Політики безпеки».

- Увімкніть параметр за допомогою "true".

- Вимкніть параметр за допомогою «false».


Приклад:

```xml
<SecurityProfile>

   <ProfileUri>http://opcfoundation.org/UA/SecurityPolicy#None</ProfileUri>

   <Enabled>false</Enabled>

</SecurityProfile>

```

У розділі <SecurityPolicies> ви налаштовуєте пов’язані «режими ·безпеки·повідомлень».

Щоб вимкнути налаштування, видаліть увесь запис <SecurityPolicy>... </Security Policy>.

Приклад:

```XML
<SecurityPolicy>

   <ProfileUri>http://opcfoundation.org/UA/SecurityPolicy#None</ProfileUri>

   <MessageSecurityModes>None</MessageSecurityModes>

</SecurityPolicy>

```

```
Незахищений зв'язок між клієнтом і сервером

Використовуйте параметр «немає» лише для тестування та діагностики.

Для безпечного зв’язку між клієнтом і сервером у робочому режимі потрібно використовувати принаймні такі налаштування:

Політика безпеки:·​Basic128Rsa15

Повідомлення·​Безпека·​Режим:·​Підписати
```

## Вказівка ідентифікації користувача

Укажіть ідентифікатор користувача для налаштування підключення в <UserTokenPolicies>. Для отримання додаткової інформації зверніться до "Концепції безпеки OPC UA"

Щоб деактивувати налаштування, видаліть весь запис.

Приклад

```xml
<UserTokenPolicy>

<TokenType>Anonymous</TokenType>

</UserTokenPolicy>

```

## Налаштування оптимізованого доступу до архіву WinCC для запису

Якщо необхідно, налаштуйте оптимізований доступ для запису в архів WinCC у <FastInsert>.

Установіть «true», щоб активувати оптимізований доступ для запису до архівів WinCC для всіх клієнтів OPC UA.

Встановіть «false», щоб установити оптимізований доступ для запису в архів WinCC для певних користувачів Windows або клієнтів OPC UA.

Ви вказуєте користувачів Windows у розділі <Users>.

Ви вказуєте клієнтів OPC UA у розділі <Clients>. Використовуйте "Загальне ім'я", яке введено в сертифікат клієнта як ClientName.

Приклад:

```xml
<EnabledByDefault>false</EnabledByDefault>
<Users>
  <User>domain\user1</User>
</Users>
<Clients>
  <Client>ClientName1</Client>
</Clients>

```

