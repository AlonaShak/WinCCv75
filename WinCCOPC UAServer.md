# Принцип роботи сервера WinCC OPC UA

## Як це працює

Сервер WinCC OPC UA надає такі значення:

Значення процесу

Значення з архівів тегів

повідомлення WinCC

Сервер WinCC OPC UA встановлюється як служба Windows і запускається автоматично. Сервер WinCC OPC UA підтримує лише профіль зв’язку «UA-TCP UA-SC UA Binary». Використовуваний номер порту регулюється.

Підтримувані характеристики

Уніфікована архітектура OPC — це специфікація для передачі значень процесу, архівних даних і повідомлень. Сервер WinCC OPC UA підтримує специфікацію OPC UA 1.03. Додаткову інформацію про підтримувані функції UA див. у розділі «Підтримувані служби та профілі OPC UA».

монтаж

Після встановлення WinCC сервер WinCC OPC UA можна використовувати негайно без необхідності будь-якої подальшої конфігурації.
Сервер WinCC OPC UA можна використовувати на сервері WinCC або клієнті WinCC.

URL-адреса сервера WinCC OPC UA

Доступ до сервера WinCC OPC UA здійснюється за такою URL-адресою:

"opc.tcp://[Ім'я хоста]:[Порт]"

Параметр
 опис

Ім'я хоста
 Заповнювач для імені комп’ютера. Використовується автоматично

Порт
 Номер порту. Значення за замовчуванням — «4862».



Сервер виявлення

«Сервер виявлення» доступний фондом OPC. «Сервер виявлення» за замовчуванням інстальовано на пристрої HMI як служба Windows.

На «Discovery Server» через сервер OPC UA доступна інформація клієнтів UA, яка зареєстрована на «Discovery Server».

Залежно від конфігурації сервер WinCC OPC UA реєструється на ні, на одному або на кількох налаштованих і доступних «серверах виявлення» під час запуску. Потім реєстрація повторюється циклічно. Якщо ви закінчите Runtime, сервер WinCC OPC UA автоматично виходить із «сервера виявлення».

Підтримувані мови в адресній області WinCC

WinCC OPC A&E Server підтримує адресну область WinCC такими мовами:

Німецький

англійська

французька

італійська

Іспанська

# Концепція безпеки OPC UA

### Вступ

Концепція безпеки OPC UA в основному базується на:

- Автентифікація та авторизація залучених програм і користувачів

- Забезпечення цілісності та конфіденційності повідомлень, якими обмінюються програми


Сертифікати є методом автентифікації програм OPC UA.

Кожна програма має власний сертифікат примірника, за допомогою якого вона ідентифікує себе в інфраструктурі відкритих ключів. Сертифікат примірника також називають «сертифікатом програми».

### Сертифікат сервера WinCC OPC UA

Для безпечної роботи кожному серверу WinCC OPC UA потрібен власний сертифікат із приватним ключем (private key), сертифікат сервера.

Сертифікат дійсний лише на **відповідному комп’ютері** та може використовуватися лише сервером WINCC OPC UA, встановленим на цьому комп’ютері.

Самопідписаний сертифікат сервера створюється та зберігається в папці сертифіката сервера.

Приватний ключ для цього сертифіката сервера також зберігається в папці сертифіката. Ви повинні обмежити доступ до папки з приватним ключем для:

- самого сервера

- системний адміністратор

```
Доступ до папки із приватим ключем

З міркувань безпеки жодні інші користувачі або програми, окрім сервера та системного адміністратора, не можуть мати доступ до закритого ключа сервера WINCC OPC UA.
```

Адміністратор заводу може замінити сертифікат сервера та відповідний приватний ключ, згенерований під час встановлення.

Відповідно до застосовної концепції безпеки для системи новий сертифікат сервера може бути самопідписаним або виданим центром сертифікації.

Сертифікати, які використовує сервер WINCC OPC UA, визначаються налаштуваннями у файлі конфігурації "OpcUaServerWinCC.xml": Ви можете знайти додаткову інформацію у розділі "Файл конфігурації сервера WinCC OPC UA".

### Зберігання сертифікатів сервера

Програма «WinCC OPC UA server» зберігається за таким шляхом:

| Storage path                                | Application          | Configuration file   |
| ------------------------------------------- | -------------------- | -------------------- |
| <Installation directory>WinCC\opc\UAServer\ | OpcUaServerWinCC.exe | OpcUaServerWinCC.xml |


Сертифікати WinCC OPC UA зберігаються в таких папках шляху встановлення WinCC:

| WinCC OPC UA server | Certificates | opc\UAServer\PKI\CA\certs   |
| :------------------ | ------------ | --------------------------- |
|                     | Private key  | opc\UAServer\PKI\CA\private |

Ви можете змінити місце зберігання у файлі конфігурації.

### Сертифікати довірених клієнтів

Сервер WinCC OPC UA підтримує безпечний зв’язок лише з надійними клієнтами. Клієнту довіряють:

- Якщо клієнт має дійсний самопідписаний сертифікат, який зберігається в пам’яті сертифікатів довірених сертифікатів сервера WinCC OPC UA

- або якщо дійсний сертифікат клієнта був виданий центром сертифікації.


Дійсний сертифікат від центру сертифікації повинен знаходитися в пам’яті сертифікатів довірених сертифікатів сервера WinCC OPC UA. У цьому випадку потрібен лише сертифікат від центру сертифікації. Сертифікат клієнта не обов’язково повинен знаходитися в сховищі сертифікатів для довірених сертифікатів.

### Зберігання клієнтських сертифікатів

Ви вказуєте параметри зберігання для довірених сертифікатів за допомогою файлу конфігурації сервера WINCC OPC UA:

| Параметр  | Значення                                                     |
| --------- | ------------------------------------------------------------ |
| StoreType | Тип зберігання сертифіката. Місцем зберігання може бути «Directory» або «Windows». |
| StorePath | У цій папці зберігаються сертифікати довірених клієнтів.     |

#### Приклад конфігурації зі сховищем «Directory»

```xml
<TrustedCertificateStore>
      <StoreType>Directory</StoreType>
      <StorePath>[ApplicationPath]\PKI\Trusted</StorePath>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
</TrustedCertificateStore>
```

У цьому випадку сервер WINCC OPC UA довіряє всім клієнтам, чиї сертифікати сервера знаходяться в папці «…PKI\TrustList\Certs».



#### Приклад конфігурації зі сховищем «Windows»

```xml
<TrustedCertificateStore>
      <StoreType>Windows</StoreType>
      <StorePath>UA Aplications</StorePath>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
</TrustedCertificateStore>
```

Для цього варіанта зберігання сертифікати клієнтів мають бути розташовані в сховищі сертифікатів операційної системи в розділі «<Локальний комп’ютер>\UA Applications».

Сертифікати центрів сертифікації, необхідні для перевірки ланцюжка сертифікатів клієнта, зберігаються в сховищі сертифікатів центрів сертифікації. Тут також ви вказуєте параметри зберігання за допомогою файлу конфігурації сервера WINCC OPC UA:

| Параметр  | Значення                                                     |
| --------- | ------------------------------------------------------------ |
| StoreType | Тип зберігання сертифіката. Місцем зберігання може бути «Directory» або «Windows». |
| StorePath | У цій папці зберігаються сертифікати довірених центрів сертифікації. |

```
Сертифікати з пам’яті центрів сертифікації не є автоматично довіреними.

Щоб центр сертифікації був надійним, його сертифікат повинен знаходитися в пам’яті для довірених сертифікатів.
```

#### Приклад конфігурації зі сховищем «Directory»

```xml
    <IssuerCertificateStore>
     <StoreType>Directory<StoreType />
      <StorePath>[ApplicationPath]\PKI\CA<StorePath/>
      <ValidationOptions>UseDefaultOptions</ValidationOptions>
    </IssuerCertificateStore>
```

У цьому випадку сертифікати довірених центрів сертифікації знаходяться в папці «…\PKI\CA\Certs».

#### Приклад конфігурації зі сховищем «Windows»

```xml
    <IssuerCertificateStore>
     <StoreType>Windows<StoreType />
     <ValidationOptions>UseDefaultOptions</ValidationOptions>
    </IssuerCertificateStore>
```

Параметр "StorePath" не має значення. Сертифікати центрів сертифікації повинні зберігатися в пам’яті сертифікатів Windows відповідно до вимог операційної системи.

Сертифікати вважаються надійними, якщо вони знаходяться в одному з цих двох місць:

- <Local computer>\Trusted root certification authorities
- <Local computer>\Third-party root certification authorities

```
Важливо для зберігання

Місце зберігання для сертифіката сервера має бути «Directory».

Два місця зберігання для сертифікатів довірених клієнтів і для сертифікатів від центрів сертифікації повинні мати однаковий StoreType, тобто обидва мають бути або «Directory», або «Windows».
```

#### Клієнтські сертифікати не приймаються

Якщо клієнт UA отримує доступ до сервера WINCC OPC UA, не маючи довіреного сертифіката, сервер WINCC OPC UA не дозволяє безпечний зв’язок і копіює сертифікат клієнта в папку для відхилених сертифікатів.

Ви вказуєте параметри зберігання для відхилених сертифікатів, наприклад, за допомогою файлу конфігурації сервера WINCC OPC UA

```xml
<RejectedCertificatesStore>
      <StoreType>Directory</StoreType>
      <StorePath>[ApplicationPath]\PKI\CA\rejected</StorePath>
    </RejectedCertificatesStore>
```

```
Тут також підтримується лише StoreType "Directory".
```

Щоб увімкнути захищений зв’язок із цим клієнтом, вам доведеться перемістити відхилений сертифікат до сховища сертифікатів для lдовірених сертифікатів.

# Налаштування механізмів безпеки

## Вступ

На комунікаційному рівні забезпечується:

- Автентичність програми UA

- Конфіденційність повідомлень, якими обмінюються

- Цілісність повідомлень, якими обмінюються


Використовувані механізми безпеки, наприклад алгоритми шифрування та підпису, визначаються стандартизованими політиками безпеки.

Політики безпеки, які підтримуються сервером WinCC OPC UA, налаштовуються за допомогою файлу конфігурації сервера в «ServerConfiguration» і «SecuredApplication».

## Конфігурація сервера

Елемент XML «SecurityPolicies» у розділі «ServerConfiguration» містить список усіх доступних комбінацій «Security Profile» і «Message Security Mode» для сервера.

| Security Profile                                             | Message Security Mode  | Description                                                  |
| ------------------------------------------------------------ | ---------------------- | ------------------------------------------------------------ |
| http://opcfoundation.org/UA/SecurityPolicy#None              | None                   | Незахищений зв'язок                                          |
| http://opcfoundation.org/UA/SecurityPolicy#Basic128Rsa15     | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |
| http://opcfoundation.org/UA/SecurityPolicy#Basic256          | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |
| http://opcfoundation.org/UA/SecurityPolicy#Basic256Sha256  (Вимоги до використання політики безпеки «Basic256Sha256»: сертифікат примірника з алгоритмом підпису «Sha256» і мінімальною довжиною ключа = 2048.) | Sign or SignAndEncrypt | Захищений зв'язок, підписані або зашифровані та підписані повідомлення |

```
Забезпечення безпечного зв'язку

Для безпечного зв’язку потрібні сертифікати сервера для сервера та клієнта та правильно налаштоване сховище сертифікатів.
```

## Приклад конфігураційного файлу з максимальною функціональністю

![](media\1.png)

## SecuredApplication

Відповідно до специфікації OPC UA, механізми безпеки явно вмикаються та вимикаються за допомогою елемента «SecurityProfileUris» у розділі «SecuredApplication».

На діаграмі нижче показано SecuredApplication, у якому незахищений зв’язок вимкнено:

![](media\2.png)

Тому сервер WinCC OPC UA підтримує дві стратегії безпеки «Basic128Rsa15» і «Basic256» під час виконання. З «Message Security Modes Sign» і «SignAndEncrypt», але без незахищеного зв’язку.

Після встановлення зв’язку клієнти UA вибирають із цього списку необхідну Політику.

## Ідентичність користувача

На додаток до механізмів безпеки на рівні зв’язку, сервер WinCC OPC UA також підтримує автентифікацію користувачів для клієнтських програм за допомогою UserTokenPolicy «UserName».

Клієнтська програма повинна надавати дійсну комбінацію імені користувача та пароля під час встановлення зв’язку. Сервер WinCC OPC UA перевіряє комбінацію в управлінні користувачами операційної системи.

UserTokenPolicy встановлюється у файлі конфігурації сервера WINCC OPC UA.

![](media\3.png)

З цією конфігурацією сервер WINCC OPC UA підтримує як анонімних користувачів, так і політику «UserName».

# Підтримувані сервіси та профілі OPC UA







# Файл конфігурації сервера WinCC OPC UA

## Вступ

Сервер WinCC OPC UA налаштовується за допомогою конфігураційного файлу "OPCUAServerWinCC.xml".

Файл конфігурації розбитий на кілька розділів. У цьому розділі описано макет файлу конфігурації.

У розділі «[Як налаштувати сервер OPC UA]()» описано, як налаштувати сервер WinCC OPC UA.

## Шлях файлу конфігурації

Для сервера WinCC OPC UA існує два файли конфігурації "OPCUAServerWinCC.xml":

| Configuration file                  | Storage path                            |
| ----------------------------------- | --------------------------------------- |
| Server-specific configuration file  | <WinCC installation path>\opc\UAServer\ |
| Project-specific configuration file | <WinCC project folder>\OPC\UAServer     |

## Редагування конфігураційного файлу

Для внесення змін у файли конфігурації вам потрібні наступні авторизації:

Server-specific configuration file -> Windows Administrator rights

Project-specific configuration file -> The user must be a member of the "SIMATIC HMI" user group

```
Ті самі параметри: Пріоритет файлів
Деякі параметри містяться в обох конфігураційних файлах.
Якщо параметри не збігаються, параметри файлу конфігурації конкретного проекту мають вищий пріоритет.
```



# Як налаштувати сервер OPC UA
